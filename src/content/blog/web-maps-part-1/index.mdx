---
title: "Writing a map library from scratch - Part 1: Basics"
description: "Off the charts"
pubDate: "Dec 18 2023"
heroImage: "/blog-placeholder-2.jpg"
---

import { Code } from "astro:components";
import Example5 from "./raw/example-5.astro";

One day, as I embarked on the journey to improve a website's performance, I stumbled upon this lighthouse report:

<figure>
  <img
    alt="Mapbox Bundle Size"
    src="/mapbox-bundle-size.png"
    className="mx-auto w-96"
  />
  <figcaption className="text-center">Mapbox bundle size</figcaption>
</figure>

And I thought, why is the <code className="bg-gray-200">mapbox-gl.js</code> library ~260kB big?
I just need to display a small map with a couple of markers! Why do I need 260kB for that?
I wondered, is this just mapbox? Or are all map libraries this big?

<figure>
	<div className="mx-auto w-72">

    	| Library                                                                                                        | Bundle Size |
    	| -------------------------------------------------------------------------------------------------------------- | ----------- |
    	| <a href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js" target="_blank">Mapbox</a>                  | ~260kB      |
    	| <a href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js" target="_blank">Maplibre</a>                 | ~190kB      |
    	| <a href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" target="_blank">Leaflet</a>                          | ~45kB       |
    	| <a href="https://cdn.maptiler.com/maptiler-sdk-js/v1.1.1/maptiler-sdk.umd.min.js" target="_blank">Maptiler</a> | ~222kB      |

    </div>
    <figcaption className="text-center">Bundle size comparison</figcaption>

</figure>

I was surprised to see that even the smallest library, Leaflet, was still 45kB big.
Also, how come, with the rise of Server-Side Rendering (SSR) and Static Site Generation (SSG),
neither is available for any of these libraries? How does a map library even work?

I mean, can't I simply write my own map library?

_oh boy._

## How does a map library work under the hood?

After a bit of research, I found this <a href="https://observablehq.com/@mourner/simple-web-map" target="_blank">great article</a>,
by the legendary <a href="https://agafonkin.com/" target="_blank">Volodymir Agafonkin</a>.
In a nutshell, a web map is a mosaic of tiles. It uses
the <a href="https://en.wikipedia.org/wiki/Web_Mercator_projection" target="_blank">Web Mercator projection</a> to
represent the earth globe on a flat surface. The amount of tiles is relative to your zoom level and map size.

At zoom level 0, you only need one tile, which will look like this:

<figure className="flex flex-col w-full items-center">
	<div className="relative w-[128px] h-[128px] sm:w-[256px] sm:h-[256px]">
		<img className="my-0" src="https://tile.osm.org/0/0/0.png" alt="A map of the world" />
		<div
			className="absolute bottom-0 right-0 bg-white bg-opacity-50 px-0.5 py-1 text-xs"
			style="font:11px sans-serif"
		>
			{/* prettier-ignore */}
			<a href="https://osm.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>
		</div>
	</div>

  <figcaption className="text-center">
    Tile at zoom level 0
  </figcaption>
</figure>

This tile is 256x256 pixels and generated by <a href="osm.org" target="_blank">OpenStreetMap</a>.
The URL is <code className="bg-gray-200">{`https://tile.osm.org/0/0/0.png`}</code>.
The URL parameters are <code className="bg-gray-200">/z/x/y.png</code>, z being the zoom level,
x the x<sup>th</sup> horizontal tile, and y the y<sup>th</sup> vertical tile.
On each higher zoom level, the amount of tiles quadruples.

At zoom level 1, you need 4 tiles, which will look like this:

<figure className="flex flex-col w-full items-center">
		<div className="relative h-[256px] w-[256px] sm:h-[512px] sm:w-[512px] overflow-hidden">
			<div className="flex flex-wrap">
				<img className="my-0 w-[128px] sm:w-auto" src="https://tile.osm.org/1/0/0.png" alt="A map showing north America" />
				<img className="my-0 w-[128px] sm:w-auto" src="https://tile.osm.org/1/1/0.png" alt="A map showing north Africa, Europe, and Asia" />
				<img className="my-0 w-[128px] sm:w-auto" src="https://tile.osm.org/1/0/1.png" alt="A map showing south America and Antarctica" />
				<img className="my-0 w-[128px] sm:w-auto" src="https://tile.osm.org/1/1/1.png" alt="A map showing south Africa, Australia, and Antarctica" />
			</div>
			<div className="absolute right-[128px] sm:right-[256px] top-0 h-[256px] sm:h-[512px] border-r border-dashed border-black" />
			<div className="absolute right-0 top-[128px] sm:top-[256px] w-[256px] sm:w-[512px] border-t border-dashed border-black" />
			<div
				className="absolute bottom-0 right-0 bg-white bg-opacity-50 px-0.5 py-1 text-xs"
				style="font:11px sans-serif"
			>
				{/* prettier-ignore */}
				<a href="https://osm.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>
			</div>
		</div>

    <figcaption className="text-center">
    	Tiles at zoom level 1
    </figcaption>

</figure>

Here, the URL parameters are <code className="bg-gray-200">/1/0/0.png</code>, <code className="bg-gray-200">/1/1/0.png</code>, <code className="bg-gray-200">/1/0/1.png</code>, and <code className="bg-gray-200">/1/1/1.png</code>.
But how do we know which tiles to fetch? And how do we know where to place them?

We'll start by choosing the center of our map. Let's say we want to center our map on Berlin, Germany.
We'll use the latitude/longitude coordinates <code className="bg-gray-200">[52.52, 13.4]</code>[^1], on zoom level 14.
Also, we'll try to fit our map in a 400x300 pixels container.
Now, we need to figure out which tiles, using the <code className="bg-gray-200">/z/x/y.png</code> parameters, we need to fetch.

On zoom level 14, the world is divided into <code className="bg-gray-200">2<sup>14</sup> = 16,384</code> x- and y-tiles.

Knowing that one tile has a size of 256 pixels, we can calculate the size of each
axis: <code className="bg-gray-200">axisSize = 16,384 ⋅ 256 = 4,194,304</code> pixels
on the x- and y-axis.

Now begins the fun part. We need to use the Web Mercator Projection formula to convert our latitude/longitude
coordinates (based on a globe) to x/y coordinates (based on a flat surface):

<div className="w-72 2xs:w-96 xs:w-[26rem] sm:w-[30rem] md:w-auto">
  <Code
    code={`x = axisSize * (longitude / 360 + 0.5);
x = 4194304 * (13.4 / 360 + 0.5);
x = 2253273.3155555557;`}
    lang="tsx"
  />
</div>

<div className="w-72 2xs:w-96 xs:w-[26rem] sm:w-[30rem] md:w-auto">
  <Code
    code={`y = (axisSize * (1 - Math.log(Math.tan(Math.PI * (0.25 + latitude / 360))) / Math.PI)) / 2;
y = (4194304 * (1 - Math.log(Math.tan(Math.PI * (0.25 + 52.52 / 360))) / Math.PI)) / 2;
y = 1375543.6427981234;`}
    lang="tsx"
  />
</div>

_Note: The Web Mercator Projection only works for latitudes between 85°N to 85°S._

Since we want to center our latitude/longitude coordinates in the middle of our container, we need to subtract half
of the container size from our x/y coordinates:

<div className="w-72 2xs:w-96 xs:w-[26rem] sm:w-[30rem] md:w-auto">
	<Code
		code={`width = 400;
height = 300;

x0 = Math.floor(x - width / 2);
x0 = 2253073;

y0 = Math.floor(y - height / 2);
y0 = 1375393;`}
lang="ts"
/>

</div>

However, x0 and y0 are coordinates in pixels. We still need to convert them to tile coordinates,
i.e. the matching number for the <code className="bg-gray-200">/z/x/y.png</code> parameters.
To do this, we need to floor divide our x0 and y0 by 256:

<div className="w-72 2xs:w-96 xs:w-[26rem] sm:w-[30rem] md:w-auto">
	<Code
		code={`topLeftCornerTileX = Math.floor(x0 / 256);
topLeftCornerTileX = 8801;

topLeftCornerTileY = Math.floor(y0 / 256);
topLeftCornerTileY = 5372;`}
lang="ts"
/>

</div>

Now, we know that we need to fetch the tile <code className="bg-gray-200">/14/8801/5372.png</code>, which is:

<figure className="flex flex-col w-full items-center">
	<div className="relative w-[128px] h-[128px] sm:w-[256px] sm:h-[256px]">
		<img className="my-0" src="https://tile.osm.org/14/8801/5372.png" alt="A map of the world" />
		<div
			className="absolute bottom-0 right-0 bg-white bg-opacity-50 px-0.5 py-1 text-xs"
			style="font:11px sans-serif"
		>
			{/* prettier-ignore */}
			<a href="https://osm.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>
		</div>
	</div>

    <figcaption className="text-center">
    	Top Left Tile
    </figcaption>

</figure>

This seems correct! Let's fill our container with the adjacent tiles and a bit of css to position it correctly:

<div className="w-72 2xs:w-96 xs:w-[26rem] sm:w-[30rem] md:w-auto">
  <Example5 />
</div>

_Et voilà:_

<div className="flex w-full justify-center">
<figure className="flex flex-col w-72 sm:w-full items-center">
	<div className="scale-[0.65] sm:scale-100">
		<div className="h-[300px] w-[400px] relative overflow-hidden -mb-16 sm:mb-0 -mt-16 sm:mt-0">
			<img src="https://tile.osm.org/14/8801/5372.png" alt="" style="
					position: absolute;
					left: -17px;
					top: -161px;" />
			<img src="https://tile.osm.org/14/8802/5372.png" alt="" style="
					position: absolute;
					left: 239px;
					top: -161px;" />
			<img src="https://tile.osm.org/14/8801/5373.png" alt="" style="
					position: absolute;
					left: -17px;
					top: 95px;" />
			<img src="https://tile.osm.org/14/8802/5373.png" alt="" style="
					position: absolute;
					left: 239px;
					top: 95px;" />
				{/* prettier-ignore */}
			<div
				className="absolute bottom-0 right-0 bg-white bg-opacity-50 px-0.5 py-1 text-xs"
				style="font:11px sans-serif"
			>
				{/* prettier-ignore */}
				<a href="https://osm.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>
			</div>
		</div>
	</div>

    <figcaption className="text-center">
    	Map of Berlin
    </figcaption>

</figure>
</div>

In <a href="/blog/web-maps-part-2/" target="_blank">Part 2</a>, we'll look at how to zoom in and out of our map.

<hr />

Footnotes:

[^1]: We directly used the decimal degrees instead of degrees, minutes, and seconds.
